# –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º GOOGLE_REFRESH_TOKEN

## –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏

### –ü—Ä–æ–±–ª–µ–º—ã

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Refresh Token**:

   - Refresh token –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —á–∞—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å `GOOGLE_REFRESH_TOKEN` –≤ —Ñ–∞–π–ª–∞—Ö `.env.local` –∏ `.env.production`
   - –§—É–Ω–∫—Ü–∏—è `updateEnvFile` –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ `GOOGLE_ACCESS_TOKEN` –∏ `GOOGLE_TOKEN_EXPIRY`, –Ω–æ –Ω–µ `GOOGLE_REFRESH_TOKEN`

2. **–†–∞–∑—Ä—ã–≤ –º–µ–∂–¥—É –¥–≤—É–º—è –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏ —Ä–∞–±–æ—Ç—ã —Å Google API**:

   - Refresh token, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –ø—Ä–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ NextAuth.js, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `GOOGLE_REFRESH_TOKEN`
   - –ù–µ—Ç –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –±—ã –∏–∑–≤–ª–µ–∫–∞–ª refresh token –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –µ–≥–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Calendar API

3. **–ü—Ä–æ–±–ª–µ–º—ã —Å —Ñ–æ—Ä–º–∞—Ç–æ–º –¥–∞–Ω–Ω—ã—Ö**:

   - –í —Ñ–∞–π–ª–µ `.env.local` –∑–Ω–∞—á–µ–Ω–∏–µ `GOOGLE_TOKEN_EXPIRY` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–∫ `NaN`, —á—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞
   - –í —Ñ–∞–π–ª–µ `.env.production` –∑–Ω–∞—á–µ–Ω–∏–µ `GOOGLE_TOKEN_EXPIRY` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–∞–∫ `1747483200000`

4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è Refresh Token**:
   - –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞, –∫–æ—Ç–æ—Ä—ã–π –±—ã —É–≤–µ–¥–æ–º–ª—è–ª –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–∏—Ç—å refresh token
   - –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ refresh token –ø—Ä–∏ –µ–≥–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–í —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:

1. –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:

   - –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ `Account` (–ø–æ–ª—è `refresh_token` –∏ `access_token`)
   - –í —Ñ–∞–π–ª–∞—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (`.env.local` –∏ `.env.production`) –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `GOOGLE_ACCESS_TOKEN`, `GOOGLE_REFRESH_TOKEN` –∏ `GOOGLE_TOKEN_EXPIRY`

2. –§—É–Ω–∫—Ü–∏—è `refreshTokenIfNeeded` –≤ —Ñ–∞–π–ª–µ `lib/utils/tokenRefresher.js` –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ `GOOGLE_ACCESS_TOKEN` –∏ `GOOGLE_TOKEN_EXPIRY` –≤ —Ñ–∞–π–ª–µ `.env.local`, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç `GOOGLE_REFRESH_TOKEN`.

3. –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á –≤ Google Calendar –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∞ –Ω–µ –∞–∫–∫–∞—É–Ω—Ç—ã –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–£—á–∏—Ç—ã–≤–∞—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ, –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:

1. **–•—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**:

   - –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å `ServiceAccount` –≤ —Å—Ö–µ–º—É Prisma –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
   - –•—Ä–∞–Ω–∏—Ç—å `refresh_token`, `access_token`, `expiry_date` –∏ –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —ç—Ç–æ–π —Ç–∞–±–ª–∏—Ü–µ
   - –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–∫–µ–Ω—ã –∏–∑ `.env` —Ñ–∞–π–ª–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

2. **–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤**:

   - –ò–∑–º–µ–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `refreshTokenIfNeeded` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –≤–º–µ—Å—Ç–æ `.env` —Ñ–∞–π–ª–æ–≤
   - –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ø–∞–º—è—Ç–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –û–±–Ω–æ–≤–ª—è—Ç—å `access_token` –∏ –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

3. **–û–±–µ—Å–ø–µ—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**:
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
   - –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ `.env` –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ

## –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```mermaid
flowchart TD
    A[–ó–∞–ø—Ä–æ—Å –∫ Google API] --> B{–¢–æ–∫–µ–Ω –≤ –∫—ç—à–µ?}
    B -->|–î–∞| C{–¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω?}
    B -->|–ù–µ—Ç| D[–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –∏–∑ –ë–î]
    D --> C
    C -->|–î–∞| E[–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π access_token]
    C -->|–ù–µ—Ç| F[–ü–æ–ª—É—á–∏—Ç—å refresh_token –∏–∑ –ë–î]
    F --> G[–ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—ã–π access_token]
    G --> H[–û–±–Ω–æ–≤–∏—Ç—å access_token –≤ –ë–î]
    H --> I[–û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è]
    I --> J[–û–±–Ω–æ–≤–∏—Ç—å –∫—ç—à –≤ –ø–∞–º—è—Ç–∏]
    J --> E
    E --> K[–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ API]
    K --> L[–í–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç]
```

## –î–∏–∞–≥—Ä–∞–º–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

```mermaid
sequenceDiagram
    participant App as –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    participant Cache as –ö—ç—à –≤ –ø–∞–º—è—Ç–∏
    participant DB as –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
    participant Google as Google API

    App->>Cache: –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞
    alt –¢–æ–∫–µ–Ω –≤ –∫—ç—à–µ –∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
        Cache-->>App: –í–µ—Ä–Ω—É—Ç—å —Ç–æ–∫–µ–Ω
    else –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
        Cache-->>App: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω/–Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
        App->>DB: –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–æ–≤
        DB-->>App: –í–µ—Ä–Ω—É—Ç—å —Ç–æ–∫–µ–Ω—ã
        alt access_token –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
            App->>Cache: –û–±–Ω–æ–≤–∏—Ç—å –∫—ç—à
            App-->>App: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å access_token
        else access_token –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
            App->>Google: –ó–∞–ø—Ä–æ—Å –Ω–æ–≤–æ–≥–æ access_token —Å refresh_token
            Google-->>App: –ù–æ–≤—ã–π access_token
            App->>DB: –û–±–Ω–æ–≤–∏—Ç—å access_token –∏ –¥–∞—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            App->>Cache: –û–±–Ω–æ–≤–∏—Ç—å –∫—ç—à
        end
    end
    App->>Google: –ó–∞–ø—Ä–æ—Å –∫ API —Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
    Google-->>App: –û—Ç–≤–µ—Ç API
```

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ö–µ–º–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å `ServiceAccount` –≤ `prisma/schema.prisma`:

```prisma
model ServiceAccount {
  id                String   @id @default(cuid())
  provider          String   // "google"
  clientId          String
  clientSecret      String
  refreshToken      String   @db.Text
  accessToken       String?  @db.Text
  expiryDate        DateTime?
  lastUpdated       DateTime @default(now()) // –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access_token
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}
```

## –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –∫–æ–¥–µ

### 1. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `lib/utils/tokenRefresher.js`

```javascript
const { google } = require('googleapis');
const prisma = require('../../lib/prisma');

// –ö—ç—à –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ø–∞–º—è—Ç–∏
let tokenCache = {
  accessToken: null,
  expiryDate: null,
};

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
 * @returns {Promise<Object>} - –û–±—ä–µ–∫—Ç —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
 */
async function getServiceAccount() {
  // –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
  let serviceAccount = await prisma.serviceAccount.findFirst({
    where: { provider: 'google' },
  });

  // –ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
  if (!serviceAccount) {
    console.log('–°–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è');
    serviceAccount = await prisma.serviceAccount.create({
      data: {
        provider: 'google',
        clientId: process.env.GOOGLE_CLIENT_ID,
        clientSecret: process.env.GOOGLE_CLIENT_SECRET,
        refreshToken: process.env.GOOGLE_REFRESH_TOKEN,
        accessToken: process.env.GOOGLE_ACCESS_TOKEN,
        expiryDate: new Date(parseInt(process.env.GOOGLE_TOKEN_EXPIRY || '0')),
        lastUpdated: new Date(),
      },
    });
    console.log('–°–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω:', serviceAccount.id);
  }

  return serviceAccount;
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
 * @param {Object} options - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
 * @param {number} options.expiryThreshold - –ü–æ—Ä–æ–≥ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º —Ç–æ–∫–µ–Ω —Å—á–∏—Ç–∞–µ—Ç—Å—è "—Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞—é—â–∏–º"
 * @returns {Promise<Object>} - –û–±—ä–µ–∫—Ç —Å —Ç–æ–∫–µ–Ω–∞–º–∏
 */
async function refreshTokenIfNeeded(options = { expiryThreshold: 300 }) {
  const currentTime = Date.now();

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –≤ –ø–∞–º—è—Ç–∏
  if (
    tokenCache.accessToken &&
    tokenCache.expiryDate &&
    tokenCache.expiryDate > currentTime + options.expiryThreshold * 1000
  ) {
    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –∫—ç—à–∞ –≤ –ø–∞–º—è—Ç–∏');
    return {
      access_token: tokenCache.accessToken,
      refresh_token: null, // –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º refresh_token –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      expiry_date: tokenCache.expiryDate,
    };
  }

  // –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
  const serviceAccount = await getServiceAccount();

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å—Ç–µ–∫–∞–µ—Ç –ª–∏ —Ç–æ–∫–µ–Ω –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è
  const expiryDate = serviceAccount.expiryDate
    ? serviceAccount.expiryDate.getTime()
    : 0;
  const thresholdTime = currentTime + options.expiryThreshold * 1000;

  // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
  if (
    !serviceAccount.accessToken ||
    !expiryDate ||
    expiryDate < thresholdTime
  ) {
    console.log('–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º...');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ refresh —Ç–æ–∫–µ–Ω–∞
    if (!serviceAccount.refreshToken) {
      throw new Error('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç refresh_token. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω.');
    }

    const oauth2Client = new google.auth.OAuth2(
      serviceAccount.clientId,
      serviceAccount.clientSecret,
      process.env.GOOGLE_REDIRECT_URI
    );

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º refresh_token –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ access_token
    oauth2Client.setCredentials({
      refresh_token: serviceAccount.refreshToken,
    });

    try {
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
      const { credentials } = await oauth2Client.refreshAccessToken();

      // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è
      const newExpiryTime = Date.now() + credentials.expires_in * 1000;

      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      await prisma.serviceAccount.update({
        where: { id: serviceAccount.id },
        data: {
          accessToken: credentials.access_token,
          expiryDate: new Date(newExpiryTime),
          lastUpdated: new Date(),
          updatedAt: new Date(),
        },
      });

      console.log('–¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –≤ –ø–∞–º—è—Ç–∏
      tokenCache.accessToken = credentials.access_token;
      tokenCache.expiryDate = newExpiryTime;

      return {
        access_token: credentials.access_token,
        refresh_token: serviceAccount.refreshToken,
        expiry_date: newExpiryTime,
      };
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞:', error);

      // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º refresh_token, –ª–æ–≥–∏—Ä—É–µ–º —ç—Ç–æ
      if (error.message.includes('invalid_grant')) {
        console.error(
          'Refresh token –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.'
        );
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
      }

      throw error;
    }
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –≤ –ø–∞–º—è—Ç–∏
  tokenCache.accessToken = serviceAccount.accessToken;
  tokenCache.expiryDate = expiryDate;

  // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—â–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
  return {
    access_token: serviceAccount.accessToken,
    refresh_token: serviceAccount.refreshToken,
    expiry_date: expiryDate,
  };
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π OAuth2 –∫–ª–∏–µ–Ω—Ç —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
 * @returns {Promise<OAuth2Client>} - –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π OAuth2 –∫–ª–∏–µ–Ω—Ç
 */
async function getAuthenticatedOAuth2Client() {
  try {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    const tokens = await refreshTokenIfNeeded();

    // –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    const serviceAccount = await getServiceAccount();

    // –°–æ–∑–¥–∞–µ–º OAuth2 –∫–ª–∏–µ–Ω—Ç
    const oauth2Client = new google.auth.OAuth2(
      serviceAccount.clientId,
      serviceAccount.clientSecret,
      process.env.GOOGLE_REDIRECT_URI
    );

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω—ã
    oauth2Client.setCredentials({
      access_token: tokens.access_token,
      refresh_token: tokens.refresh_token,
      expiry_date: tokens.expiry_date,
    });

    return oauth2Client;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ OAuth2 –∫–ª–∏–µ–Ω—Ç–∞:', error);

    // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
    console.log(
      '–ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç'
    );

    const oauth2Client = new google.auth.OAuth2(
      process.env.GOOGLE_CLIENT_ID,
      process.env.GOOGLE_CLIENT_SECRET,
      process.env.GOOGLE_REDIRECT_URI
    );

    if (process.env.GOOGLE_ACCESS_TOKEN) {
      oauth2Client.setCredentials({
        access_token: process.env.GOOGLE_ACCESS_TOKEN,
        refresh_token: process.env.GOOGLE_REFRESH_TOKEN,
        expiry_date: parseInt(process.env.GOOGLE_TOKEN_EXPIRY || '0', 10),
      });
    }

    return oauth2Client;
  }
}

module.exports = {
  refreshTokenIfNeeded,
  getAuthenticatedOAuth2Client,
  getServiceAccount,
};
```

### 2. –°–∫—Ä–∏–ø—Ç –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ `.env` –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

```javascript
// scripts/migrate-tokens-to-db.js
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

async function migrateTokensToDB() {
  try {
    console.log('–ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ .env –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
    const existingAccount = await prisma.serviceAccount.findFirst({
      where: { provider: 'google' },
    });

    if (existingAccount) {
      console.log('–°–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
      console.log('ID:', existingAccount.id);
      console.log('Provider:', existingAccount.provider);
      console.log('Last Updated:', existingAccount.lastUpdated);
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if (
      !process.env.GOOGLE_CLIENT_ID ||
      !process.env.GOOGLE_CLIENT_SECRET ||
      !process.env.GOOGLE_REFRESH_TOKEN
    ) {
      console.error('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è');
      console.error('GOOGLE_CLIENT_ID:', !!process.env.GOOGLE_CLIENT_ID);
      console.error(
        'GOOGLE_CLIENT_SECRET:',
        !!process.env.GOOGLE_CLIENT_SECRET
      );
      console.error(
        'GOOGLE_REFRESH_TOKEN:',
        !!process.env.GOOGLE_REFRESH_TOKEN
      );
      return;
    }

    // –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    const serviceAccount = await prisma.serviceAccount.create({
      data: {
        provider: 'google',
        clientId: process.env.GOOGLE_CLIENT_ID,
        clientSecret: process.env.GOOGLE_CLIENT_SECRET,
        refreshToken: process.env.GOOGLE_REFRESH_TOKEN,
        accessToken: process.env.GOOGLE_ACCESS_TOKEN,
        expiryDate: new Date(parseInt(process.env.GOOGLE_TOKEN_EXPIRY || '0')),
        lastUpdated: new Date(),
      },
    });

    console.log('–¢–æ–∫–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö');
    console.log('ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞:', serviceAccount.id);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤:', error);
  } finally {
    await prisma.$disconnect();
  }
}

migrateTokensToDB();
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API-–º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

```javascript
// pages/api/auth/refresh-google-token.js
import {
  refreshTokenIfNeeded,
  getServiceAccount,
} from '../../../lib/utils/tokenRefresher';
import prisma from '../../../lib/prisma';

export default async function handler(req, res) {
  // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ POST –∑–∞–ø—Ä–æ—Å—ã
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method Not Allowed' });
  }

  try {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω
    const tokens = await refreshTokenIfNeeded();

    // –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    const serviceAccount = await getServiceAccount();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è expiry_date
    let expiryDateISO;
    let expiresInSeconds;

    try {
      // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç Date –∏ –ø–æ–ª—É—á–∏—Ç—å ISO —Å—Ç—Ä–æ–∫—É
      expiryDateISO = new Date(parseInt(tokens.expiry_date)).toISOString();
      expiresInSeconds = Math.floor((tokens.expiry_date - Date.now()) / 1000);
    } catch (error) {
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è + 1 —á–∞—Å
      const defaultExpiryTime = Date.now() + 3600 * 1000;
      expiryDateISO = new Date(defaultExpiryTime).toISOString();
      expiresInSeconds = 3600;
      console.log('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è expiry_date');
    }

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
    return res.status(200).json({
      success: true,
      message: '–¢–æ–∫–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã',
      expiry_date: expiryDateISO,
      expires_in_seconds: expiresInSeconds,
      last_updated: serviceAccount.lastUpdated.toISOString(),
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤:', error);
    return res.status(500).json({
      success: false,
      error: error.message,
    });
  }
}
```

## –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é Prisma –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ `ServiceAccount`**:

   ```bash
   npx prisma migrate dev --name add_service_account
   ```

2. **–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `lib/utils/tokenRefresher.js`** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

3. **–°–æ–∑–¥–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤** –∏–∑ `.env` –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:

   ```bash
   node scripts/migrate-tokens-to-db.js
   ```

4. **–û–±–Ω–æ–≤–∏—Ç—å API-–º–∞—Ä—à—Ä—É—Ç** –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

5. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ –≤ dev-–æ–∫—Ä—É–∂–µ–Ω–∏–∏**:

   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–æ–∫–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `refreshTokenIfNeeded` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ API-–º–∞—Ä—à—Ä—É—Ç `/api/auth/refresh-google-token` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á –≤ Google Calendar —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

6. **–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ production**:
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é Prisma –≤ production
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ –≤ production
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ production

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è

1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**:

   - –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ, —á–µ–º –≤ —Ñ–∞–π–ª–∞—Ö `.env`
   - –ú–µ—Ö–∞–Ω–∏–∑–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø–∞–º—è—Ç–∏ –ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
   - –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:

   - –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
   - Refresh token –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É
   - –î–æ—Å—Ç—É–ø –∫ —Ç–æ–∫–µ–Ω–∞–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç—å—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

3. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ**:

   - –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ `tokenRefresher.js`
   - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ñ—É–Ω–∫—Ü–∏–π –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º, —á—Ç–æ –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç—è—Ö –∫–æ–¥–∞
   - –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è

4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**:
   - –†–µ—à–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ –±—É–¥—É—â–µ–º
   - –ú–µ—Ö–∞–Ω–∏–∑–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø–∞–º—è—Ç–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–ø—Ä–æ—Å–æ–≤

## –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ –±—É–¥—É—â–µ–º

1. **–ú–µ—Ö–∞–Ω–∏–∑–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞** –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–∏—Ç—å refresh token
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ refresh token** –ø—Ä–∏ –µ–≥–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏
3. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ç–æ–∫–µ–Ω–∞–º–∏** –¥–ª—è –∞—É–¥–∏—Ç–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏
5. **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è GOOGLE_REFRESH_TOKEN –≤ –∫–∞–±–∏–Ω–µ—Ç–µ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞

–î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —É–¥–æ–±–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏ Google API –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è `GOOGLE_REFRESH_TOKEN` –≤ –∫–∞–±–∏–Ω–µ—Ç–µ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞.

### 1. API-–º–∞—Ä—à—Ä—É—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏

```javascript
// pages/api/admin/superadmin/google-tokens.js
import { getServerSession } from 'next-auth/next';
import { authOptions } from '../../auth/[...nextauth]';
import prisma from '../../../../lib/prisma';
import { getServiceAccount } from '../../../../lib/utils/tokenRefresher';

export default async function handler(req, res) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  const session = await getServerSession(req, res, authOptions);

  if (!session || session.user.role !== 'superadmin') {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ GET –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
  if (req.method === 'GET') {
    try {
      // –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      const serviceAccount = await getServiceAccount();

      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–∫–µ–Ω–∞—Ö (–±–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
      return res.status(200).json({
        clientId: serviceAccount.clientId,
        clientSecret: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢', // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á
        refreshToken: serviceAccount.refreshToken,
        accessToken: serviceAccount.accessToken,
        expiryDate: serviceAccount.expiryDate,
        lastUpdated: serviceAccount.lastUpdated,
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–∫–µ–Ω–∞—Ö:', error);
      return res
        .status(500)
        .json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–∫–µ–Ω–∞—Ö' });
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ PUT –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
  if (req.method === 'PUT') {
    try {
      const { clientId, clientSecret, refreshToken } = req.body;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      if (!clientId || !refreshToken) {
        return res
          .status(400)
          .json({ error: '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ' });
      }

      // –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      const serviceAccount = await getServiceAccount();

      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
      await prisma.serviceAccount.update({
        where: { id: serviceAccount.id },
        data: {
          clientId,
          // –û–±–Ω–æ–≤–ª—è–µ–º clientSecret —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω
          ...(clientSecret && clientSecret !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'
            ? { clientSecret }
            : {}),
          refreshToken,
          updatedAt: new Date(),
        },
      });

      // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
      await prisma.adminActionLog.create({
        data: {
          adminId: session.user.id,
          action: 'update_google_tokens',
          entityType: 'service_account',
          entityId: serviceAccount.id,
          details: {
            updatedFields: [
              'clientId',
              'refreshToken',
              ...(clientSecret && clientSecret !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'
                ? ['clientSecret']
                : []),
            ],
          },
        },
      });

      return res
        .status(200)
        .json({ success: true, message: '–¢–æ–∫–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã' });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤:', error);
      return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤' });
    }
  }

  // –ï—Å–ª–∏ –º–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
  return res.status(405).json({ error: 'Method Not Allowed' });
}
```

### 2. –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞

```javascript
// pages/admin/superadmin/google-tokens.js
import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/router';
import Head from 'next/head';
import AdminLayout from '../../../components/admin/AdminLayout';
import { useNotification } from '../../../contexts/NotificationContext';
import styles from '../../../styles/admin/AdminForm.module.css';

export default function GoogleTokensPage() {
  const router = useRouter();
  const { data: session, status } = useSession();
  const { showSuccess, showError } = useNotification();

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–∫–µ–Ω–∞—Ö
  const [tokenData, setTokenData] = useState({
    clientId: '',
    clientSecret: '',
    refreshToken: '',
    accessToken: '',
    expiryDate: '',
    lastUpdated: '',
  });

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
  const [isLoading, setIsLoading] = useState(true);
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  const [isSaving, setIsSaving] = useState(false);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –∏–º–µ–µ—Ç –ª–∏ –æ–Ω —Ä–æ–ª—å —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
  useEffect(() => {
    if (status === 'authenticated') {
      if (session.user.role !== 'superadmin') {
        router.push('/admin');
      } else {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–∫–µ–Ω–∞—Ö
        fetchTokenData();
      }
    } else if (status === 'unauthenticated') {
      router.push('/admin/superadmin-signin');
    }
  }, [status, session, router]);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–∫–µ–Ω–∞—Ö
  const fetchTokenData = async () => {
    try {
      setIsLoading(true);
      const response = await fetch('/api/admin/superadmin/google-tokens');

      if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–∫–µ–Ω–∞—Ö');
      }

      const data = await response.json();

      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      let formattedExpiryDate = '';
      if (data.expiryDate) {
        formattedExpiryDate = new Date(data.expiryDate).toLocaleString();
      }

      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      let formattedLastUpdated = '';
      if (data.lastUpdated) {
        formattedLastUpdated = new Date(data.lastUpdated).toLocaleString();
      }

      setTokenData({
        clientId: data.clientId || '',
        clientSecret: data.clientSecret || '',
        refreshToken: data.refreshToken || '',
        accessToken: data.accessToken || '',
        expiryDate: formattedExpiryDate,
        lastUpdated: formattedLastUpdated,
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–∫–µ–Ω–∞—Ö:', error);
      showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–∫–µ–Ω–∞—Ö Google');
    } finally {
      setIsLoading(false);
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
  const handleChange = (e) => {
    const { name, value } = e.target;
    setTokenData((prev) => ({ ...prev, [name]: value }));
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
  const handleSubmit = async (e) => {
    e.preventDefault();

    try {
      setIsSaving(true);

      const response = await fetch('/api/admin/superadmin/google-tokens', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          clientId: tokenData.clientId,
          clientSecret: tokenData.clientSecret,
          refreshToken: tokenData.refreshToken,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤');
      }

      showSuccess('–¢–æ–∫–µ–Ω—ã Google —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');

      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      fetchTokenData();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤:', error);
      showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω—ã: ${error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access_token
  const handleRefreshToken = async () => {
    try {
      setIsSaving(true);

      const response = await fetch('/api/auth/refresh-google-token', {
        method: 'POST',
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞');
      }

      const data = await response.json();

      showSuccess('Access token —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');

      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      fetchTokenData();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ access token:', error);
      showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å access token: ${error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å–µ—Å—Å–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
  if (
    status === 'loading' ||
    (status === 'authenticated' && session.user.role !== 'superadmin')
  ) {
    return (
      <AdminLayout>
        <div className={styles.loadingContainer}>
          <div className={styles.loadingSpinner}></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
      </AdminLayout>
    );
  }

  return (
    <AdminLayout>
      <Head>
        <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏ Google | –ü–∞–Ω–µ–ª—å —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
      </Head>

      <div className={styles.pageHeader}>
        <h1 className={styles.pageTitle}>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏ Google</h1>
      </div>

      {isLoading ? (
        <div className={styles.loadingContainer}>
          <div className={styles.loadingSpinner}></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–∫–µ–Ω–∞—Ö...</p>
        </div>
      ) : (
        <div className={styles.formContainer}>
          <form onSubmit={handleSubmit} className={styles.form}>
            <div className={styles.formGroup}>
              <label htmlFor="clientId" className={styles.label}>
                Client ID:
              </label>
              <input
                type="text"
                id="clientId"
                name="clientId"
                value={tokenData.clientId}
                onChange={handleChange}
                className={styles.input}
                required
              />
            </div>

            <div className={styles.formGroup}>
              <label htmlFor="clientSecret" className={styles.label}>
                Client Secret:
              </label>
              <input
                type="password"
                id="clientSecret"
                name="clientSecret"
                value={tokenData.clientSecret}
                onChange={handleChange}
                className={styles.input}
                required
              />
            </div>

            <div className={styles.formGroup}>
              <label htmlFor="refreshToken" className={styles.label}>
                Refresh Token:
              </label>
              <textarea
                id="refreshToken"
                name="refreshToken"
                value={tokenData.refreshToken}
                onChange={handleChange}
                className={styles.textarea}
                rows={3}
                required
              />
            </div>

            <div className={styles.formGroup}>
              <label htmlFor="accessToken" className={styles.label}>
                Access Token (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è):
              </label>
              <textarea
                id="accessToken"
                name="accessToken"
                value={tokenData.accessToken}
                className={styles.textarea}
                rows={3}
                readOnly
                disabled
              />
            </div>

            <div className={styles.formGroup}>
              <label className={styles.label}>
                –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è Access Token:
              </label>
              <div className={styles.readOnlyField}>
                {tokenData.expiryDate || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
              </div>
            </div>

            <div className={styles.formGroup}>
              <label className={styles.label}>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</label>
              <div className={styles.readOnlyField}>
                {tokenData.lastUpdated || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
              </div>
            </div>

            <div className={styles.buttonGroup}>
              <button
                type="submit"
                className={styles.submitButton}
                disabled={isSaving}
              >
                {isSaving ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è'}
              </button>
              <button
                type="button"
                className={styles.refreshButton}
                onClick={handleRefreshToken}
                disabled={isSaving}
              >
                –û–±–Ω–æ–≤–∏—Ç—å Access Token
              </button>
            </div>
          </form>
        </div>
      )}
    </AdminLayout>
  );
}
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏ –≤ –º–µ–Ω—é —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞

```javascript
// components/admin/AdminSidebar.js
// –î–æ–±–∞–≤–∏—Ç—å –≤ –º–µ–Ω—é —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏

// –ü—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é
{
  session.user.role === 'superadmin' && (
    <>
      {/* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞ */}
      <li className={styles.menuItem}>
        <Link href="/admin/superadmin/google-tokens">
          <a
            className={
              router.pathname === '/admin/superadmin/google-tokens'
                ? styles.activeLink
                : ''
            }
          >
            <span className={styles.menuIcon}>üîë</span>
            <span className={styles.menuText}>–¢–æ–∫–µ–Ω—ã Google</span>
          </a>
        </Link>
      </li>
    </>
  );
}
```

### 4. –î–∏–∞–≥—Ä–∞–º–º–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞

```mermaid
sequenceDiagram
    participant SA as –°—É–ø–µ—Ä–∞–¥–º–∏–Ω
    participant UI as –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    participant API as API-—Å–µ—Ä–≤–µ—Ä
    participant DB as –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
    participant Google as Google API

    SA->>UI: –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏
    UI->>API: GET /api/admin/superadmin/google-tokens
    API->>DB: –ó–∞–ø—Ä–æ—Å —Ç–µ–∫—É—â–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
    DB-->>API: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã
    API-->>UI: –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ —Ç–æ–∫–µ–Ω—ã

    SA->>UI: –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç Refresh Token
    SA->>UI: –ù–∞–∂–∏–º–∞–µ—Ç "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    UI->>API: PUT /api/admin/superadmin/google-tokens
    API->>DB: –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã
    API->>DB: –õ–æ–≥–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    DB-->>API: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    API-->>UI: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ

    SA->>UI: –ù–∞–∂–∏–º–∞–µ—Ç "–û–±–Ω–æ–≤–∏—Ç—å Access Token"
    UI->>API: POST /api/auth/refresh-google-token
    API->>DB: –ü–æ–ª—É—á–∞–µ—Ç Refresh Token
    DB-->>API: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Refresh Token
    API->>Google: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π Access Token
    Google-->>API: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–π Access Token
    API->>DB: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–π Access Token
    API-->>UI: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    UI-->>SA: –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

7. **–°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞**:

   - –°–æ–∑–¥–∞—Ç—å API-–º–∞—Ä—à—Ä—É—Ç `/api/admin/superadmin/google-tokens`
   - –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É `/admin/superadmin/google-tokens`
   - –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –º–µ–Ω—é —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞

8. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞–º–∏**:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Refresh Token
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Access Token —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
