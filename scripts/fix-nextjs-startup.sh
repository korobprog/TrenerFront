#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –∑–∞–ø—É—Å–∫–∞ Next.js —Å–µ—Ä–≤–µ—Ä–∞
# –ê–≤—Ç–æ—Ä: Roo
# –î–∞—Ç–∞: 30.05.2025

echo "üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º Next.js —Å–µ—Ä–≤–µ—Ä–∞..."

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Next.js
check_processes() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Next.js..."
    NEXT_PROCESSES=$(ps aux | grep -E "(next|npm.*dev)" | grep -v grep | wc -l)
    if [ $NEXT_PROCESSES -gt 0 ]; then
        log "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Next.js: $NEXT_PROCESSES"
        return 1
    else
        log "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã Next.js –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã"
        return 0
    fi
}

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Next.js
stop_processes() {
    log "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Next.js..."
    pkill -f "next" 2>/dev/null || true
    pkill -f "npm.*dev" 2>/dev/null || true
    sleep 2
    log "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

# –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
clear_cache() {
    log "–û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ Next.js..."
    
    # –£–¥–∞–ª–µ–Ω–∏–µ .next
    if [ -d ".next" ]; then
        rm -rf .next
        log "‚úÖ –£–¥–∞–ª–µ–Ω .next"
    fi
    
    # –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ node_modules
    if [ -d "node_modules/.cache" ]; then
        rm -rf node_modules/.cache
        log "‚úÖ –û—á–∏—â–µ–Ω –∫–µ—à node_modules"
    fi
    
    log "‚úÖ –ö–µ—à –æ—á–∏—â–µ–Ω"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check_dependencies() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    if [ ! -d "node_modules" ]; then
        log "‚ö†Ô∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è node_modules –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        return 1
    fi
    
    if [ ! -f "package-lock.json" ]; then
        log "‚ö†Ô∏è  –§–∞–π–ª package-lock.json –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    if [ ! -d "node_modules/next" ]; then
        log "‚ö†Ô∏è  Next.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        return 1
    fi
    
    if [ ! -d "node_modules/react" ]; then
        log "‚ö†Ô∏è  React –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        return 1
    fi
    
    log "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–∫–µ"
    return 0
}

# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
reinstall_dependencies() {
    log "–ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    if [ -d "node_modules" ]; then
        rm -rf node_modules
        log "‚úÖ –£–¥–∞–ª–µ–Ω node_modules"
    fi
    
    if [ -f "package-lock.json" ]; then
        rm -f package-lock.json
        log "‚úÖ –£–¥–∞–ª–µ–Ω package-lock.json"
    fi
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    log "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    npm install
    
    if [ $? -eq 0 ]; then
        log "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
        return 0
    else
        log "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        return 1
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
check_ports() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ—Ä—Ç–æ–≤..."
    
    PORT_3000=$(netstat -tlnp 2>/dev/null | grep :3000 | wc -l)
    if [ $PORT_3000 -gt 0 ]; then
        log "‚ö†Ô∏è  –ü–æ—Ä—Ç 3000 –∑–∞–Ω—è—Ç"
        return 1
    else
        log "‚úÖ –ü–æ—Ä—Ç 3000 —Å–≤–æ–±–æ–¥–µ–Ω"
        return 0
    fi
}

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
test_server() {
    log "–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
    
    # –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ
    timeout 30 npm run dev &
    SERVER_PID=$!
    
    # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
    sleep 15
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
    if curl -s http://localhost:3000 >/dev/null 2>&1; then
        log "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ"
        kill $SERVER_PID 2>/dev/null || true
        return 0
    else
        log "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        kill $SERVER_PID 2>/dev/null || true
        return 1
    fi
}

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
create_backups() {
    log "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π..."
    
    BACKUP_DIR="backups/nextjs-$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$BACKUP_DIR"
    
    # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    if [ -f "package.json" ]; then
        cp package.json "$BACKUP_DIR/"
    fi
    
    if [ -f "next.config.js" ]; then
        cp next.config.js "$BACKUP_DIR/"
    fi
    
    if [ -d "pages" ]; then
        cp -r pages "$BACKUP_DIR/"
    fi
    
    log "‚úÖ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ–∑–¥–∞–Ω—ã –≤ $BACKUP_DIR"
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    log "üöÄ –ù–∞—á–∞–ª–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ Next.js —Å–µ—Ä–≤–µ—Ä–∞"
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
    create_backups
    
    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    if ! check_processes; then
        stop_processes
    fi
    
    # –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
    clear_cache
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
    check_ports
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    if ! check_dependencies; then
        log "‚ö†Ô∏è  –ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏, –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞..."
        if ! reinstall_dependencies; then
            log "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
            exit 1
        fi
    fi
    
    # –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫
    if test_server; then
        log "üéâ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞! –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
        log "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å: npm run dev"
    else
        log "‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"
        log "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: DEBUG=next:* npm run dev"
        exit 1
    fi
    
    log "‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
}

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
main "$@"