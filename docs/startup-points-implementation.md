# Автоматическое начисление стартового балла при регистрации

## Обзор

Реализована система автоматического начисления стартового балла новым пользователям при первой регистрации в приложении. Каждый новый пользователь получает 1 балл, который может быть использован для участия в собеседованиях в качестве собеседуемого.

## Техническая реализация

### 1. Модификация NextAuth.js конфигурации

**Файл:** `pages/api/auth/[...nextauth].js`

Добавлено событие `createUser` в конфигурацию NextAuth:

```javascript
events: {
  async createUser({ user }) {
    // Начисляем стартовый балл при создании нового пользователя
    await handleFirstTimeUserRegistration(user, { provider: 'oauth' });
  },
}
```

### 2. Функция начисления стартового балла

Реализована функция `handleFirstTimeUserRegistration`, которая:

- Проверяет отсутствие предыдущих начислений стартового балла
- Создает запись в таблице `UserPoints` с 1 баллом
- Создает транзакцию в таблице `PointsTransaction` для отслеживания
- Использует транзакции базы данных для атомарности операций
- Предотвращает дублирование начислений

```javascript
async function handleFirstTimeUserRegistration(user, account) {
  try {
    const STARTUP_POINTS = 1; // Стартовый балл для новых пользователей

    await prisma.$transaction(async (tx) => {
      // Проверяем, есть ли уже транзакция начисления стартового балла
      const existingStartupTransaction = await tx.pointsTransaction.findFirst({
        where: {
          userId: user.id,
          type: 'startup_bonus',
        },
      });

      // Создаем транзакцию только если её ещё нет
      if (!existingStartupTransaction) {
        // Создаем запись UserPoints с стартовым балансом
        await tx.userPoints.create({
          data: {
            userId: user.id,
            points: STARTUP_POINTS,
          },
        });

        // Создаем транзакцию начисления
        await tx.pointsTransaction.create({
          data: {
            userId: user.id,
            amount: STARTUP_POINTS,
            type: 'startup_bonus',
            description: 'Стартовый балл за регистрацию',
          },
        });

        console.log(
          `Начислен стартовый балл (${STARTUP_POINTS}) пользователю: ${user.email}`
        );
      }
    });
  } catch (error) {
    console.error('Ошибка при начислении стартового балла:', error);
    // Не прерываем процесс авторизации из-за ошибки начисления баллов
  }
}
```

## Структура базы данных

### Таблица UserPoints

- `userId` - ID пользователя (связь с таблицей User)
- `points` - текущий баланс баллов пользователя
- `createdAt` - дата создания записи
- `updatedAt` - дата последнего обновления

### Таблица PointsTransaction

- `userId` - ID пользователя
- `amount` - количество баллов (положительное для начисления)
- `type` - тип транзакции (`startup_bonus` для стартового балла)
- `description` - описание транзакции
- `createdAt` - дата создания транзакции

## Логика работы

### 1. Регистрация нового пользователя

1. Пользователь регистрируется через OAuth (Google/GitHub) или credentials
2. NextAuth.js создает запись пользователя в базе данных
3. Срабатывает событие `createUser`
4. Вызывается функция `handleFirstTimeUserRegistration`
5. Проверяется отсутствие предыдущих начислений стартового балла
6. Создается запись в `UserPoints` с 1 баллом
7. Создается запись в `PointsTransaction` с типом `startup_bonus`

### 2. Предотвращение дублирования

- Проверка существования транзакции типа `startup_bonus` для пользователя
- Использование транзакций базы данных для атомарности
- Обработка ошибок без прерывания процесса авторизации

### 3. Интеграция с существующими API

Существующие API endpoints продолжают работать без изменений:

- `GET /api/user/points` - получение текущего баланса
- `GET /api/user/points-history` - получение истории транзакций

## Тестирование

### 1. Базовый тест логики

**Файл:** `test-startup-points.js`

Тестирует:

- Создание пользователя и начисление стартового балла
- Создание соответствующих записей в базе данных
- Предотвращение дублирования начислений

### 2. Интеграционный тест

**Файл:** `test-nextauth-integration.js`

Тестирует:

- Интеграцию с событием NextAuth `createUser`
- Корректность работы API endpoints
- Полный цикл регистрации и начисления

### Запуск тестов

```bash
# Базовый тест
NODE_ENV=development DATABASE_URL="..." node test-startup-points.js

# Интеграционный тест
NODE_ENV=development DATABASE_URL="..." node test-nextauth-integration.js
```

## Результаты тестирования

✅ **Все тесты пройдены успешно:**

- Стартовый балл корректно начисляется новым пользователям
- Создается соответствующая транзакция в истории
- Предотвращается дублирование начислений
- API корректно возвращает данные о баллах
- История транзакций ведется правильно

## Конфигурация

### Размер стартового балла

Текущий размер стартового балла: **1 балл**

Для изменения размера стартового балла измените константу `STARTUP_POINTS` в функции `handleFirstTimeUserRegistration`.

### Типы транзакций

- `startup_bonus` - стартовый балл за регистрацию
- Другие типы транзакций определяются в других частях системы

## Мониторинг и логирование

- Успешные начисления логируются в консоль
- Ошибки логируются с полной информацией
- Процесс авторизации не прерывается при ошибках начисления баллов

## Безопасность

- Использование транзакций базы данных для атомарности
- Проверка дублирования для предотвращения злоупотреблений
- Обработка ошибок без раскрытия чувствительной информации

## Совместимость

- Работает с OAuth провайдерами (Google, GitHub)
- Совместимо с существующей системой баллов
- Не влияет на существующих пользователей
- Обратная совместимость с API endpoints

## Будущие улучшения

1. **Настраиваемый размер стартового балла** - возможность изменения через админ-панель
2. **Условные начисления** - начисление разных сумм в зависимости от источника регистрации
3. **Аналитика** - отслеживание эффективности стартовых баллов
4. **Уведомления** - информирование пользователей о начисленном стартовом балле

## Заключение

Система автоматического начисления стартового балла успешно реализована и протестирована. Новые пользователи теперь автоматически получают 1 балл при регистрации, что позволяет им сразу участвовать в собеседованиях в качестве собеседуемых.
