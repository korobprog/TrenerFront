# Решение проблем с подключением к серверу и настройкой NGINX для supermock.ru

## Содержание

1. [Проблема с подключением к серверу](#проблема-с-подключением-к-серверу)

   - [Диагностика проблемы](#диагностика-проблемы)
   - [Решение проблемы](#решение-проблемы)
   - [Использование скрипта fix_ssh_connection.sh](#использование-скрипта-fix_ssh_connectionsh)

2. [Настройка NGINX с SSL-сертификатами](#настройка-nginx-с-ssl-сертификатами)

   - [Проблема с путями к сертификатам](#проблема-с-путями-к-сертификатам)
   - [Обновление конфигурации NGINX](#обновление-конфигурации-nginx)
   - [Использование скрипта update_nginx_config.sh](#использование-скрипта-update_nginx_configsh)

3. [Проверка и мониторинг](#проверка-и-мониторинг)

   - [Проверка доступности сайта](#проверка-доступности-сайта)
   - [Мониторинг срока действия сертификатов](#мониторинг-срока-действия-сертификатов)
   - [Диагностика ошибок](#диагностика-ошибок)

4. [Дополнительные рекомендации](#дополнительные-рекомендации)

## Проблема с подключением к серверу

### Диагностика проблемы

При попытке подключения к серверу командой `ssh supermock` возникает ошибка:

```
ssh: Could not resolve hostname supermock: Temporary failure in name resolution
```

Эта ошибка указывает на то, что система не может разрешить имя хоста "supermock" в IP-адрес. Это может происходить по следующим причинам:

1. Имя хоста "supermock" не зарегистрировано в DNS
2. Отсутствует запись в локальном файле `/etc/hosts`
3. Отсутствует конфигурация в файле `~/.ssh/config`

### Решение проблемы

Существует несколько способов решения этой проблемы:

#### Способ 1: Использование IP-адреса вместо имени хоста

Самый простой способ - использовать IP-адрес сервера вместо имени хоста:

```bash
ssh user@IP_ADDRESS
```

Замените `user` на ваше имя пользователя на сервере, а `IP_ADDRESS` на IP-адрес сервера supermock.ru.

#### Способ 2: Настройка файла /etc/hosts

Добавьте запись в файл `/etc/hosts` для разрешения имени supermock:

```bash
sudo sh -c 'echo "IP_ADDRESS supermock" >> /etc/hosts'
```

Замените `IP_ADDRESS` на IP-адрес сервера supermock.ru.

После этого вы сможете подключаться командой:

```bash
ssh user@supermock
```

#### Способ 3: Настройка файла ~/.ssh/config

Создайте или отредактируйте файл `~/.ssh/config`:

```bash
mkdir -p ~/.ssh
chmod 700 ~/.ssh
cat >> ~/.ssh/config << EOF
Host supermock
    HostName IP_ADDRESS
    User your_username
    Port 22
    IdentityFile ~/.ssh/id_rsa
EOF
chmod 600 ~/.ssh/config
```

Замените:

- `IP_ADDRESS` на IP-адрес сервера
- `your_username` на ваше имя пользователя на сервере
- `~/.ssh/id_rsa` на путь к вашему приватному ключу, если он отличается

После этого вы сможете подключаться просто командой:

```bash
ssh supermock
```

### Использование скрипта fix_ssh_connection.sh

Для автоматической диагностики и решения проблемы с подключением к серверу был создан скрипт `fix_ssh_connection.sh`. Этот скрипт:

1. Проверяет текущее состояние подключения
2. Проверяет наличие записей в `/etc/hosts` и `~/.ssh/config`
3. Пытается разрешить имена "supermock" и "supermock.ru" через DNS
4. Предлагает решения проблемы с подключением

Для использования скрипта:

```bash
chmod +x fix_ssh_connection.sh
./fix_ssh_connection.sh
```

## Настройка NGINX с SSL-сертификатами

### Проблема с путями к сертификатам

Проблема с доступом к сайту supermock.ru (ошибка "502 Bad Gateway") связана с неправильными путями к SSL-сертификатам в конфигурации NGINX. Сертификаты сохранены в нестандартной директории `/etc/nginx/sites-available/`, но в конфигурации указаны стандартные пути.

### Обновление конфигурации NGINX

Для решения проблемы необходимо обновить конфигурацию NGINX с правильными путями к сертификатам:

```nginx
# Стандартные пути (неправильные)
ssl_certificate /etc/letsencrypt/live/supermock.ru/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/supermock.ru/privkey.pem;

# Обновленные пути (правильные)
ssl_certificate /etc/nginx/sites-available/fullchain.pem;
ssl_certificate_key /etc/nginx/sites-available/privkey.pem;
```

Также необходимо настроить правильные права доступа к сертификатам:

```bash
sudo chown root:root /etc/nginx/sites-available/fullchain.pem
sudo chown root:root /etc/nginx/sites-available/privkey.pem
sudo chmod 644 /etc/nginx/sites-available/fullchain.pem
sudo chmod 600 /etc/nginx/sites-available/privkey.pem
```

### Использование скрипта update_nginx_config.sh

Для автоматического обновления конфигурации NGINX был создан скрипт `update_nginx_config.sh`. Этот скрипт:

1. Создает резервные копии текущих конфигураций и сертификатов
2. Обновляет конфигурацию NGINX с правильными путями к сертификатам
3. Настраивает правильные права доступа к сертификатам
4. Проверяет конфигурацию и перезапускает NGINX
5. Проверяет доступность сайта
6. Создает скрипты для автоматического обновления сертификатов и мониторинга срока их действия

Для использования скрипта:

```bash
chmod +x update_nginx_config.sh
sudo ./update_nginx_config.sh
```

## Проверка и мониторинг

### Проверка доступности сайта

После обновления конфигурации NGINX проверьте доступность сайта:

```bash
curl -I https://supermock.ru
```

Или откройте сайт в браузере: https://supermock.ru

### Мониторинг срока действия сертификатов

Скрипт `update_nginx_config.sh` создает дополнительный скрипт `/usr/local/bin/check-ssl-expiry.sh` для мониторинга срока действия сертификатов. Вы можете запустить его вручную:

```bash
/usr/local/bin/check-ssl-expiry.sh
```

Также скрипт добавляет задание в crontab для ежедневной проверки срока действия сертификатов и отправки уведомлений по электронной почте.

### Диагностика ошибок

Если после обновления конфигурации возникают ошибки:

1. Проверьте логи NGINX:

```bash
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/supermock-https-error.log
```

2. Проверьте статус NGINX:

```bash
sudo systemctl status nginx
```

3. Проверьте конфигурацию NGINX:

```bash
sudo nginx -t
```

4. Проверьте, запущено ли Next.js приложение:

```bash
ps aux | grep "node.*next"
```

5. Проверьте, открыт ли порт 3000 (Next.js):

```bash
netstat -tuln | grep ":3000"
```

## Дополнительные рекомендации

1. **Регулярное обновление сертификатов**: Убедитесь, что сертификаты регулярно обновляются с помощью Certbot или другого инструмента.

2. **Мониторинг доступности сайта**: Настройте мониторинг доступности сайта с помощью инструментов, таких как Uptime Robot, Pingdom или Zabbix.

3. **Резервное копирование конфигураций**: Регулярно создавайте резервные копии конфигураций NGINX и сертификатов.

4. **Логирование**: Анализируйте логи NGINX для выявления потенциальных проблем и оптимизации производительности.

5. **Безопасность**: Регулярно обновляйте NGINX и другие компоненты сервера для устранения уязвимостей безопасности.
