# Руководство по миграции Google токенов

Это руководство описывает процесс миграции Google токенов из `.env` файлов в базу данных и переход на новую систему обновления токенов.

## Почему нужна миграция?

Хранение Google токенов в `.env` файлах имеет несколько недостатков:

1. **Перезапуск сервера**: При изменении `.env.local` в dev-режиме Next.js автоматически перезапускает сервер, что приводит к потере состояния.
2. **Проблемы с деплоем**: При изменении `.env.production` на сервере требуется перезапуск приложения.
3. **Безопасность и масштабирование**: Хранение токенов в `.env` файлах уязвимо и не масштабируется при множестве пользователей.

## Новый подход

Новый подход использует модель `Account` в базе данных для хранения Google токенов. Это позволяет:

1. **Избежать перезапусков сервера** при обновлении токенов
2. **Поддерживать множество пользователей** с разными токенами
3. **Повысить безопасность** хранения токенов

## Шаги миграции

### 1. Запустите скрипт миграции

Скрипт `scripts/migrate-google-tokens.js` переносит токены из `.env` файлов в базу данных:

```bash
# Миграция для пользователя с ролью superadmin (автоматический поиск)
node scripts/migrate-google-tokens.js

# Миграция для конкретного пользователя по ID
node scripts/migrate-google-tokens.js USER_ID

# Миграция для конкретного пользователя по email
node scripts/migrate-google-tokens.js user@example.com

# Миграция с проверкой валидности токенов
node scripts/migrate-google-tokens.js --validate

# Миграция для конкретного пользователя с проверкой валидности токенов
node scripts/migrate-google-tokens.js USER_ID --validate
```

### 2. Проверьте миграцию

После миграции проверьте, что токены успешно сохранены в базе данных:

```sql
SELECT * FROM "Account" WHERE provider = 'google';
```

### 3. Протестируйте функциональность

Протестируйте создание Google Meet-ссылок и другие функции, использующие Google API:

1. Войдите в систему
2. Создайте новое собеседование
3. Убедитесь, что Google Meet-ссылка успешно создается

### 4. Удалите токены из .env файлов

После успешного тестирования можно удалить токены из `.env` файлов:

```
# Удалите эти строки из .env.local и .env.production
GOOGLE_ACCESS_TOKEN=...
GOOGLE_REFRESH_TOKEN=...
GOOGLE_TOKEN_EXPIRY=...
```

Оставьте только необходимые для OAuth2 авторизации переменные:

```
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GOOGLE_REDIRECT_URI=...
```

## Как работает новая система

### Получение токенов

```javascript
// Получение токенов для пользователя
const tokens = await getGoogleTokensFromDB(userId);
```

### Обновление токенов

```javascript
// Обновление токенов при необходимости
const tokens = await refreshTokenIfNeeded({ userId, expiryThreshold: 300 });
```

### Получение OAuth2 клиента

```javascript
// Получение OAuth2 клиента с актуальными токенами
const oauth2Client = await getAuthenticatedOAuth2Client(userId);
```

## Обратная совместимость

Для обеспечения обратной совместимости, функции по-прежнему могут работать с токенами из переменных окружения, если `userId` не указан. Однако этот режим считается устаревшим и будет удален в будущих версиях.

## Устранение неполадок

### Ошибка "Токены Google не найдены для пользователя"

Убедитесь, что:

1. Пользователь существует в базе данных
2. Для пользователя создан аккаунт Google в таблице `Account`
3. В аккаунте есть `refresh_token`

### Ошибка "invalid_grant"

Эта ошибка может возникнуть, если:

1. Пользователь отозвал доступ к приложению
2. Refresh token устарел (не использовался более 6 месяцев)

Решение: пользователю необходимо заново авторизоваться через Google OAuth.

### Ошибка "GOOGLE_REFRESH_TOKEN не найден в .env файлах"

Эта ошибка возникает, если скрипт не может найти переменную `GOOGLE_REFRESH_TOKEN` в .env файлах. Убедитесь, что:

1. Файлы `.env.local` или `.env.production` существуют
2. В этих файлах определена переменная `GOOGLE_REFRESH_TOKEN`

### Ошибка "Пользователь не найден"

Эта ошибка возникает, если скрипт не может найти пользователя по указанному ID, email или с ролью superadmin. Убедитесь, что:

1. Указан корректный ID или email пользователя
2. Пользователь существует в базе данных
3. Если не указан конкретный пользователь, в системе должен быть хотя бы один пользователь с ролью superadmin

### Ошибка при проверке токенов

При проверке валидности токенов могут возникнуть следующие ошибки:

1. **invalid_token**: Access token недействителен
2. **invalid_grant**: Refresh token недействителен или отозван

В этом случае скрипт предложит продолжить миграцию или отменить её. Если вы продолжите миграцию с недействительными токенами, они будут сохранены в базе данных, но не будут работать. Пользователю потребуется заново авторизоваться через Google OAuth.

## Дополнительная информация

Для получения дополнительной информации о правильном обновлении Google токенов см. документ `google-token-refresh-solution.md`.

## Расширенные возможности скрипта миграции

Обновленный скрипт миграции `scripts/migrate-google-tokens.js` предоставляет следующие дополнительные возможности:

### Поиск пользователя по email

Вы можете указать email пользователя вместо ID:

```bash
node scripts/migrate-google-tokens.js user@example.com
```

### Проверка валидности токенов

Добавлен флаг `--validate` для проверки валидности токенов перед миграцией:

```bash
node scripts/migrate-google-tokens.js --validate
```

Скрипт попытается использовать токены для получения информации о пользователе Google и сообщит, если токены недействительны. При проверке выводится следующая информация:

```
Проверяем валидность токенов...
Токены валидны. Информация о пользователе Google:
- Email: user@example.com
- Name: User Name
```

В случае недействительных токенов скрипт запросит подтверждение для продолжения миграции:

```
Предупреждение: Токены не прошли проверку валидности
Вы можете продолжить миграцию, но токены могут не работать
Хотите продолжить миграцию? (y/n)
>
```

### Загрузка токенов из пользовательских .env файлов

Скрипт поддерживает загрузку токенов из пользовательских .env файлов, что может быть полезно в различных окружениях. Для этого необходимо модифицировать скрипт, добавив путь к пользовательскому .env файлу:

```javascript
// Пример модификации скрипта для использования пользовательского .env файла
const envVars = loadEnvFiles('/path/to/custom/.env');
```

### Подробное логирование

Улучшено логирование процесса миграции, что помогает отслеживать каждый шаг и диагностировать возможные проблемы. Пример вывода логов:

```
=== Начало миграции Google токенов ===
Загружаем переменные из .env.local
Загружаем переменные из .env.production
Ищем пользователя по ID: 123456
Мигрируем токены для пользователя: Admin User (admin@example.com)
Обновляем существующий аккаунт Google
Аккаунт с ID abc123 успешно обновлен
Миграция токенов успешно завершена!

=== Следующие шаги ===
1. Проверьте, что токены успешно сохранены в базе данных:
   SELECT * FROM "Account" WHERE provider = 'google' AND "userId" = '123456';
2. Протестируйте функциональность создания Google Meet
3. После успешного тестирования можно удалить токены из .env файлов:
   - GOOGLE_ACCESS_TOKEN
   - GOOGLE_REFRESH_TOKEN
   - GOOGLE_TOKEN_EXPIRY
```
