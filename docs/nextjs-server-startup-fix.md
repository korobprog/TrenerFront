# Решение проблемы зависания Next.js сервера

## Описание проблемы

Next.js сервер зависал на этапе инициализации, показывая только "Starting..." и никогда не переходя в состояние "Ready". Порт 3000 не слушался, сервер был недоступен.

## Диагностированные причины

1. **Поврежденные зависимости node_modules** - основная причина
2. **Сложные компоненты и API роуты** - вторичная причина
3. **Проблемы с кешем Next.js** - дополнительная причина

## Выполненное решение

### 1. Очистка кеша и процессов

```bash
# Остановка всех процессов Next.js
pkill -f "next" || true

# Полная очистка кеша Next.js
rm -rf .next

# Очистка кеша node_modules
rm -rf node_modules/.cache
```

### 2. Создание минимальной конфигурации

- Временно отключены API роуты (переименованы в `.disabled`)
- Создан минимальный `_app.js` без сложных импортов
- Создан простейший `index.js` для тестирования

### 3. Переустановка зависимостей

```bash
# Полное удаление зависимостей
rm -rf node_modules package-lock.json

# Чистая установка
npm install
```

### 4. Результат

После переустановки зависимостей сервер успешно запустился:

```
✓ Ready in 3.7s
○ Compiling / ...
✓ Compiled / in 4.3s (260 modules)
GET / 200 in 4552ms
```

## Меры предотвращения проблемы

### 1. Автоматический скрипт диагностики

Создан скрипт `scripts/fix-nextjs-startup.sh` для автоматической диагностики и исправления проблем:

```bash
# Запуск скрипта диагностики
./scripts/fix-nextjs-startup.sh
```

Скрипт выполняет:

- Остановку зависших процессов
- Очистку кеша Next.js
- Проверку целостности зависимостей
- Переустановку при необходимости
- Тестовый запуск сервера
- Создание резервных копий

### 2. Добавление в package.json

Добавлены новые скрипты для удобства:

```json
{
  "scripts": {
    "dev:clean": "rm -rf .next && npm run dev",
    "dev:fix": "./scripts/fix-nextjs-startup.sh",
    "cache:clear": "rm -rf .next node_modules/.cache"
  }
}
```

### 3. Регулярные проверки

- Еженедельная очистка кеша: `npm run cache:clear`
- При проблемах с запуском: `npm run dev:fix`
- Для чистого запуска: `npm run dev:clean`

### 4. Мониторинг состояния

Признаки проблем:

- Сервер показывает только "Starting..." более 30 секунд
- Порт 3000 недоступен после запуска
- В логах: `pageFiles Set(0) {}`
- Процесс Next.js завершается без ошибок

### 5. Восстановление API роутов

После успешного запуска минимальной конфигурации:

```bash
# Восстановление API роутов
mv pages/api.backup.disabled pages/api.backup
mv pages/api.temp.disabled pages/api.temp

# Восстановление страниц
mv pages.disabled/* pages/

# Восстановление _app.js
cp pages/_app.js.backup pages/_app.js
```

### 6. Профилактические меры

1. **Регулярное обновление зависимостей**:

   ```bash
   npm audit fix
   npm update
   ```

2. **Мониторинг размера node_modules**:

   ```bash
   du -sh node_modules/
   ```

3. **Проверка версий**:
   ```bash
   node --version  # Должно быть >= 18.0.0
   npm --version   # Должно быть >= 8.0.0
   ```

## Быстрое решение проблемы

При возникновении проблемы выполните:

```bash
# 1. Автоматическое исправление
./scripts/fix-nextjs-startup.sh

# 2. Если не помогло - ручное исправление
pkill -f "next"
rm -rf .next node_modules package-lock.json
npm install
npm run dev
```

## Контакты для поддержки

- Документация: `docs/nextjs-server-startup-fix.md`
- Скрипт диагностики: `scripts/fix-nextjs-startup.sh`
- Логи: `next-debug.log` (создается при DEBUG=next:\*)

---

**Дата создания**: 30.05.2025
**Автор**: Roo
**Статус**: ✅ Проблема решена
