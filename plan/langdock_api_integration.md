# План интеграции Langdock API

## Текущая реализация API

В настоящее время проект использует API Anthropic Claude для обработки запросов пользователей. Основная логика работы с API реализована в файле `lib/utils/anthropicApi.js`. Текущая реализация включает:

1. **Получение настроек API** (`getApiSettings`) - получает настройки API из базы данных, с поддержкой пользовательских настроек
2. **Форматирование промпта** (`formatPrompt`) - подготавливает промпт для отправки в API
3. **Кэширование ответов** (`cacheResponse`, `getCachedResponse`) - для оптимизации использования API
4. **Логирование использования** (`logUsage`) - отслеживает использование API пользователями
5. **Сохранение вопросов и ответов** (`saveQuestionAnswer`) - сохраняет историю взаимодействия
6. **Проверка лимитов пользователя** (`checkUserLimits`) - контролирует количество запросов
7. **Основная функция получения ответа** (`getAnswer`) - координирует весь процесс

## Langdock API

Langdock API предоставляет несколько типов API:

1. **Completion API** - для генерации текста (OpenAI Chat completion, Anthropic Messages, Codestral)
2. **Embedding API** - для создания векторных представлений текста
3. **Assistant API** - для работы с предварительно настроенными ассистентами
4. **Knowledge Folder API** - для работы с базами знаний

Для нашего проекта наиболее подходящим является **Assistant API**, который позволяет:

- Использовать предварительно настроенных ассистентов
- Передавать контекст в виде сообщений
- Получать структурированные ответы
- Использовать дополнительные возможности, такие как поиск в интернете, анализ данных и т.д.

## Необходимые изменения для интеграции Langdock API

### 1. Модификация схемы базы данных

Необходимо обновить таблицу `interviewAssistantSettings` для хранения:

- ID ассистента Langdock
- Базового URL для Langdock API
- Региона API (eu/us)

### 2. Создание нового модуля для работы с Langdock API

Создать новый файл `lib/utils/langdockApi.js` со следующими функциями:

- `getApiSettings` - получение настроек API (можно адаптировать из текущей реализации)
- `formatMessages` - форматирование сообщений для Langdock Assistant API
- `parseResponse` - обработка ответа от Langdock API
- `getAnswer` - основная функция для получения ответа

### 3. Обновление административного интерфейса

Обновить страницу `pages/admin/interview-assistant-settings.js` для:

- Добавления полей для настройки Langdock API
- Возможности выбора между Anthropic API и Langdock API
- Настройки ID ассистента и других параметров

### 4. Обновление пользовательских настроек API

Модифицировать компонент `components/user/ApiSettingsForm.js` для:

- Поддержки пользовательских настроек Langdock API
- Возможности выбора между Anthropic API и Langdock API

### 5. Обновление API-эндпоинтов

Обновить серверные эндпоинты для поддержки нового API:

- Модифицировать обработчики запросов для использования соответствующего API
- Обеспечить обратную совместимость для плавного перехода

## План миграции

### Этап 1: Подготовка

1. Создать ассистента в Langdock с необходимыми инструкциями и настройками
2. Получить API-ключ и ID ассистента
3. Обновить схему базы данных для хранения новых настроек

### Этап 2: Разработка

1. Создать модуль `lib/utils/langdockApi.js` для работы с Langdock API
2. Обновить административный интерфейс для настройки Langdock API
3. Обновить пользовательские настройки API
4. Модифицировать API-эндпоинты для поддержки обоих API

### Этап 3: Тестирование

1. Провести тестирование работы с Langdock API
2. Сравнить качество и скорость ответов между Anthropic API и Langdock API
3. Оптимизировать настройки ассистента в Langdock для улучшения качества ответов

### Этап 4: Внедрение

1. Постепенно переводить пользователей на Langdock API
2. Мониторить использование API и качество ответов
3. Собирать обратную связь от пользователей

### Этап 5: Полный переход

1. После успешного тестирования и оптимизации полностью перейти на Langdock API
2. Удалить устаревший код для работы с Anthropic API (опционально)

## Технические детали интеграции

### Формат запроса к Langdock Assistant API

```javascript
const response = await fetch(
  'https://api.langdock.com/assistant/v1/chat/completions',
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      assistantId: 'asst_123', // ID ассистента из настроек
      messages: [
        {
          role: 'user',
          content: 'Вопрос пользователя',
        },
      ],
    }),
  }
);
```

### Формат ответа от Langdock Assistant API

```javascript
{
  "result": [
    {
      "id": "msg_123",
      "role": "assistant",
      "content": [
        {
          "type": "text",
          "text": "Ответ ассистента"
        }
      ]
    }
  ]
}
```

### Расчет использования токенов

Langdock API предоставляет информацию об использовании токенов в ответе, которую можно использовать для логирования и контроля лимитов.

## Преимущества перехода на Langdock API

1. **Предварительно настроенные ассистенты** - возможность создания и настройки ассистентов через веб-интерфейс
2. **Поддержка различных моделей** - доступ к различным моделям OpenAI и Anthropic
3. **Дополнительные возможности** - поиск в интернете, анализ данных, генерация изображений
4. **Структурированные ответы** - возможность получения ответов в заданном формате
5. **Единый API** - унифицированный интерфейс для работы с различными моделями

## Потенциальные риски и их минимизация

1. **Изменение формата ответов** - необходимо обеспечить совместимость с текущим форматом или обновить клиентский код
2. **Стоимость использования** - провести анализ стоимости использования Langdock API по сравнению с прямым использованием Anthropic API
3. **Зависимость от третьей стороны** - обеспечить возможность быстрого переключения между API в случае проблем
