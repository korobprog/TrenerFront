# Решение проблем при выполнении миграции Prisma

## Общие проблемы и их решения

### 1. Ошибка "Cannot read properties of undefined (reading 'findMany')"

**Проблема**: API-эндпоинты не могут найти методы `findMany` или `findUnique` для моделей Prisma.

**Возможные причины**:

- Миграция не была применена к базе данных
- Клиент Prisma не был сгенерирован после обновления схемы
- Проблемы с подключением к базе данных

**Решения**:

1. Создать и применить миграцию:

   ```bash
   npx prisma migrate dev --name add_mock_interviews
   ```

2. Сгенерировать клиент Prisma:

   ```bash
   npx prisma generate
   ```

3. Проверить подключение к базе данных:
   ```bash
   npx prisma studio
   ```

### 2. Ошибка "P1001: Can't reach database server"

**Проблема**: Prisma не может подключиться к базе данных.

**Возможные причины**:

- База данных не запущена
- Неправильный URL для подключения к базе данных
- Проблемы с сетью

**Решения**:

1. Проверить, запущена ли база данных:

   ```bash
   docker-compose ps
   ```

2. Проверить URL для подключения к базе данных в файле `.env` или `.env.local`:

   ```
   DATABASE_URL="postgresql://username:password@localhost:5432/dbname?schema=public"
   ```

3. Перезапустить базу данных:
   ```bash
   docker-compose restart db
   ```

### 3. Ошибка "P1001: Migration failed"

**Проблема**: Миграция не может быть применена к базе данных.

**Возможные причины**:

- Конфликты с существующими таблицами или данными
- Проблемы с правами доступа к базе данных
- Синтаксические ошибки в схеме Prisma

**Решения**:

1. Проверить логи миграции:

   ```bash
   npx prisma migrate status
   ```

2. Сбросить базу данных и применить все миграции заново:

   ```bash
   npx prisma migrate reset --force
   ```

3. Проверить схему Prisma на наличие ошибок:
   ```bash
   npx prisma validate
   ```

### 4. Ошибка "P2002: Unique constraint failed"

**Проблема**: Нарушение уникального ограничения при применении миграции.

**Возможные причины**:

- Попытка добавить уникальное ограничение на столбец, который уже содержит дубликаты
- Попытка добавить запись с уже существующим уникальным значением

**Решения**:

1. Проверить данные в таблице на наличие дубликатов:

   ```sql
   SELECT column_name, COUNT(*) FROM table_name GROUP BY column_name HAVING COUNT(*) > 1;
   ```

2. Удалить дубликаты перед добавлением уникального ограничения:

   ```sql
   DELETE FROM table_name WHERE id NOT IN (SELECT MIN(id) FROM table_name GROUP BY column_name);
   ```

3. Изменить схему Prisma, чтобы не использовать уникальное ограничение, если это возможно.

### 5. Ошибка "P2025: Record not found"

**Проблема**: Запись не найдена при выполнении операции.

**Возможные причины**:

- Попытка обновить или удалить запись, которая не существует
- Попытка получить запись по несуществующему идентификатору

**Решения**:

1. Проверить наличие записи перед выполнением операции:

   ```javascript
   const record = await prisma.model.findUnique({ where: { id } });
   if (record) {
     // Выполнить операцию
   }
   ```

2. Использовать метод `upsert` для создания записи, если она не существует:
   ```javascript
   await prisma.model.upsert({
     where: { id },
     update: {
       /* ... */
     },
     create: {
       /* ... */
     },
   });
   ```

## Проблемы с Docker

### 1. Ошибка "Connection refused"

**Проблема**: Не удается подключиться к базе данных в контейнере Docker.

**Возможные причины**:

- Контейнер не запущен
- Неправильный порт для подключения
- Проблемы с сетью Docker

**Решения**:

1. Проверить статус контейнера:

   ```bash
   docker-compose ps
   ```

2. Проверить логи контейнера:

   ```bash
   docker-compose logs db
   ```

3. Перезапустить контейнер:
   ```bash
   docker-compose restart db
   ```

### 2. Ошибка "Permission denied"

**Проблема**: Нет прав доступа к файлам или директориям в контейнере Docker.

**Возможные причины**:

- Проблемы с правами доступа к томам Docker
- Неправильные настройки пользователя в контейнере

**Решения**:

1. Изменить права доступа к томам Docker:

   ```bash
   chmod -R 777 ./prisma
   ```

2. Проверить настройки пользователя в Dockerfile или docker-compose.yml.

## Проблемы с Next.js

### 1. Ошибка "Module not found"

**Проблема**: Не удается найти модуль при импорте.

**Возможные причины**:

- Неправильный путь к модулю
- Модуль не установлен
- Проблемы с кэшем Next.js

**Решения**:

1. Проверить путь к модулю:

   ```javascript
   import prisma from '../../../lib/prisma';
   ```

2. Установить недостающие модули:

   ```bash
   npm install
   ```

3. Очистить кэш Next.js:
   ```bash
   rm -rf .next
   ```

### 2. Ошибка "API resolved without sending a response"

**Проблема**: API-эндпоинт не отправляет ответ.

**Возможные причины**:

- Отсутствие return перед res.status().json()
- Необработанные исключения
- Асинхронные операции, которые не завершаются

**Решения**:

1. Добавить return перед res.status().json():

   ```javascript
   return res.status(200).json({ data });
   ```

2. Обернуть код в try-catch:

   ```javascript
   try {
     // Код
   } catch (error) {
     console.error(error);
     return res.status(500).json({ message: 'Ошибка сервера' });
   }
   ```

3. Использовать await для асинхронных операций:
   ```javascript
   const data = await prisma.model.findMany();
   ```

## Заключение

Если после применения всех этих решений проблемы сохраняются, может потребоваться более глубокий анализ кода и структуры проекта. В этом случае рекомендуется:

1. Проверить логи приложения и базы данных
2. Проверить код API-эндпоинтов на наличие ошибок
3. Проверить структуру базы данных с помощью Prisma Studio
4. Проверить настройки подключения к базе данных
5. Проверить версии используемых пакетов и их совместимость
