# План решения проблем с подключением к серверу и настройкой NGINX для supermock.ru

## Содержание

1. [Анализ проблемы](#анализ-проблемы)
2. [Решение проблемы с подключением к серверу](#решение-проблемы-с-подключением-к-серверу)
3. [Настройка NGINX с SSL-сертификатами](#настройка-nginx-с-ssl-сертификатами)
4. [Запуск Next.js приложения](#запуск-nextjs-приложения)
5. [Проверка результатов](#проверка-результатов)
6. [Рекомендации по обслуживанию](#рекомендации-по-обслуживанию)

## Анализ проблемы

Были выявлены две основные проблемы:

1. **Проблема с подключением к серверу по имени хоста "supermock"**

   - Ошибка: "Could not resolve hostname supermock"
   - Причина: Отсутствие записи в DNS или локальном файле /etc/hosts

2. **Ошибка "502 Bad Gateway" при попытке доступа к сайту**
   - Причина 1: Неправильные пути к SSL-сертификатам в конфигурации NGINX
   - Причина 2: Не запущено Next.js приложение на порту 3000

## Решение проблемы с подключением к серверу

### Диагностика

Для диагностики проблемы с подключением был использован скрипт `fix_ssh_connection.sh`, который выполнил следующие проверки:

1. Проверка наличия записи в файле `/etc/hosts`
2. Проверка наличия конфигурации в файле `~/.ssh/config`
3. Проверка DNS-разрешения имен "supermock" и "supermock.ru"

Результаты диагностики:

- Запись для supermock не найдена в файле /etc/hosts
- Конфигурация SSH для supermock найдена в файле ~/.ssh/config с IP-адресом 217.198.6.238
- Команда dig не найдена, поэтому DNS-разрешение не удалось проверить

### Решение

Проблема с подключением к серверу была решена благодаря существующей конфигурации в файле `~/.ssh/config`:

```
Host supermock
    HostName 217.198.6.238
    User root
    IdentityFile ~/.ssh/korob
    IdentitiesOnly yes
```

Эта конфигурация позволяет подключаться к серверу по имени хоста "supermock", используя IP-адрес 217.198.6.238.

## Настройка NGINX с SSL-сертификатами

### Диагностика

Проблема с ошибкой "502 Bad Gateway" была связана с двумя факторами:

1. Неправильные пути к SSL-сертификатам в конфигурации NGINX
2. Не запущенное Next.js приложение на порту 3000

### Решение

#### Шаг 1: Копирование скрипта setup_nginx_ssl.sh на сервер

```bash
scp setup_nginx_ssl.sh supermock:/root/
```

#### Шаг 2: Запуск скрипта setup_nginx_ssl.sh на сервере

```bash
ssh supermock "chmod +x /root/setup_nginx_ssl.sh && sudo /root/setup_nginx_ssl.sh"
```

Скрипт выполнил следующие действия:

1. Создал резервные копии текущих конфигураций NGINX
2. Проверил наличие сертификатов и скопировал их из стандартной директории Let's Encrypt
3. Создал новый конфигурационный файл с обновленными путями к сертификатам
4. Настроил правильные права доступа к сертификатам
5. Создал символическую ссылку в sites-enabled
6. Проверил конфигурацию NGINX
7. Перезапустил NGINX
8. Проверил доступность сайта (сайт был недоступен из-за не запущенного Next.js приложения)
9. Создал скрипт для автоматического обновления сертификатов

## Запуск Next.js приложения

### Диагностика

После настройки NGINX сайт все еще был недоступен с ошибкой "502 Bad Gateway". Диагностика показала, что Next.js приложение не запущено и порт 3000 не прослушивается.

### Решение

#### Шаг 1: Поиск директории с Next.js приложением

```bash
ssh supermock "find / -name package.json -type f | grep -v node_modules 2>/dev/null"
```

Найдены потенциальные директории с Next.js приложениями:

- /root/supermock/app/
- /root/supermock/TrenerFront/

#### Шаг 2: Проверка содержимого package.json

```bash
ssh supermock "cat /root/supermock/app/package.json"
```

Подтверждено, что в директории `/root/supermock/app/` находится Next.js приложение с именем "interview-prep".

#### Шаг 3: Запуск Next.js приложения

```bash
ssh supermock "cd /root/supermock/app && npm run start"
```

## Проверка результатов

### Проверка доступности сайта

```bash
ssh supermock "wget -qO- https://supermock.ru"
```

Сайт успешно вернул HTML-страницу с заголовком "Подготовка к собеседованию Frontend разработчика".

### Проверка статуса NGINX

```bash
ssh supermock "systemctl status nginx"
```

NGINX успешно запущен и работает. Есть предупреждения о конфликтующих именах серверов "supermock.ru" на портах 80 и 443, но это не критично, так как сайт доступен.

## Рекомендации по обслуживанию

1. **Автоматический запуск Next.js приложения при перезагрузке сервера**

   - Настроить systemd-сервис для автоматического запуска Next.js приложения
   - Пример конфигурации в файле `/etc/systemd/system/nextjs.service`:

   ```
   [Unit]
   Description=Next.js application
   After=network.target

   [Service]
   User=root
   WorkingDirectory=/root/supermock/app
   ExecStart=/usr/bin/npm run start
   Restart=always
   RestartSec=10
   StandardOutput=syslog
   StandardError=syslog
   SyslogIdentifier=nextjs

   [Install]
   WantedBy=multi-user.target
   ```

2. **Регулярное обновление сертификатов**

   - Убедиться, что certbot настроен для автоматического обновления сертификатов
   - Проверить работу скрипта `/etc/letsencrypt/renewal-hooks/post/copy-certs.sh`

3. **Мониторинг доступности сайта**

   - Настроить мониторинг доступности сайта с помощью инструментов, таких как Uptime Robot или Pingdom
   - Настроить оповещения при недоступности сайта

4. **Регулярное резервное копирование**

   - Настроить регулярное резервное копирование конфигураций NGINX и сертификатов
   - Настроить резервное копирование базы данных и файлов приложения

5. **Решение проблемы с конфликтующими именами серверов**
   - Проверить все конфигурационные файлы в директории `/etc/nginx/sites-available/`
   - Удалить или объединить дублирующиеся конфигурации для домена supermock.ru
