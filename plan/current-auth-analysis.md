# Анализ текущей системы аутентификации Next.js приложения

## Обзор

Данный отчет содержит комплексный анализ текущей системы аутентификации в Next.js приложении для подготовки к реализации многоуровневой аутентификации с тремя методами (username/password, GitHub OAuth, Google OAuth) и условной аутентификацией для Google Calendar функций.

## 1. Анализ NextAuth.js конфигурации

### Файл: `pages/api/auth/[...nextauth].js`

#### Текущие провайдеры аутентификации:

1. **Google Provider**

   - Настроен с полными OAuth2 параметрами
   - Использует расширенные scopes для Google Calendar и Gmail
   - Включена опция `allowDangerousEmailAccountLinking: true`
   - Настроен для offline доступа с `access_type: 'offline'`

2. **Credentials Provider**
   - Настроен только для суперадминистратора
   - Поддерживает логин через username/password
   - Использует bcrypt для хеширования паролей
   - Имеет fallback на hardcoded пароль для обратной совместимости

#### Настройки сессий и токенов:

- **Стратегия сессий**: JWT
- **Время жизни сессии**: 24 часа
- **Adapter**: PrismaAdapter для интеграции с базой данных
- **Secret**: Настроен через переменную окружения

#### Callbacks:

1. **JWT callback**: Добавляет роль пользователя и userId в токен
2. **Session callback**: Передает роль и ID пользователя в сессию
3. **SignIn callback**:
   - Логирует информацию о Google токенах
   - Проверяет роль для credentials провайдера
   - Разрешает вход через Google для всех пользователей

#### Кастомные страницы:

- **signIn**: `/auth/signin`
- **error**: `/auth/error`

## 2. Анализ компонентов аутентификации

### Файл: `components/auth/AuthButton.js`

#### Функциональность:

- Использует хуки `useSession`, `signIn`, `signOut` из next-auth/react
- Отображает состояние загрузки
- Показывает информацию о пользователе (имя, изображение)
- Предоставляет кнопку выхода
- Для неавторизованных пользователей показывает только Google вход

#### Ограения текущей реализации:

- Поддерживает только Google OAuth
- Отсутствует поддержка других провайдеров
- Нет возможности выбора метода аутентификации

### Файл: `pages/auth/signin.js`

#### Особенности:

- Динамически загружает доступные провайдеры
- Обрабатывает ошибки аутентификации
- Поддерживает кастомные иконки для провайдеров
- Имеет fallback для случая недоступности провайдеров

## 3. Анализ интеграции с Google

### Файл: `lib/utils/googleCalendar.js`

#### Google API интеграция:

- Использует Google Calendar API v3
- Создает события с Google Meet ссылками
- Поддерживает автоматическое обновление токенов
- Имеет механизм повторных попыток при ошибках

#### Используемые scopes:

```javascript
'https://www.googleapis.com/auth/userinfo.email';
'https://www.googleapis.com/auth/userinfo.profile';
'https://www.googleapis.com/auth/calendar';
'https://www.googleapis.com/auth/calendar.events';
```

#### Управление токенами:

- Интеграция с `tokenRefresher.js`
- Поддержка пользовательских токенов из БД
- Fallback на токены из переменных окружения

### Файл: `pages/api/auth/refresh-google-token.js`

#### Функциональность:

- API endpoint для обновления Google токенов
- Проверка сессии пользователя
- Поиск Google аккаунта в БД
- Возврат информации о времени истечения токенов

### Файл: `lib/utils/tokenRefresher.js`

#### Ключевые функции:

1. `getGoogleTokensFromDB(userId)` - получение токенов из БД
2. `updateGoogleTokensInDB(userId, accessToken, expiresAt)` - обновление токенов
3. `refreshTokenIfNeeded(options)` - автоматическое обновление токенов
4. `getAuthenticatedOAuth2Client(userId)` - создание OAuth2 клиента

#### Особенности:

- Детальное логирование для отладки
- Поддержка fallback на переменные окружения
- Проверка валидности токенов с настраиваемым порогом
- Обработка ошибок с повторными попытками

## 4. Анализ структуры базы данных

### Файл: `prisma/schema.prisma`

#### Модели для аутентификации:

1. **User**

   - `id`: String (cuid)
   - `email`: String (unique)
   - `name`, `image`: String (optional)
   - `role`: String (default: "user")
   - `password`: String (optional, для credentials)
   - Связи с Account, Session

2. **Account** (NextAuth.js)

   - `userId`: String
   - `provider`: String (google, credentials)
   - `refresh_token`, `access_token`: String
   - `expires_at`: Int
   - `refresh_token_expires_in`: Int

3. **Session** (NextAuth.js)

   - `sessionToken`: String (unique)
   - `userId`: String
   - `expires`: DateTime

4. **VerificationToken** (NextAuth.js)
   - Для email верификации

#### Дополнительные модели:

- **UserApiSettings**: Пользовательские API настройки
- **UserPoints**: Система баллов
- **MockInterview**: Собеседования
- **AdminActionLog**: Логи администратора

## 5. Анализ переменных окружения

### Файл: `.env.production`

#### OAuth настройки:

```env
NEXTAUTH_URL=https://supermock.ru
NEXTAUTH_SECRET=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
GOOGLE_CLIENT_ID=949504431957-gooelob9ord4ifsi25v8slm0h0kqrnol.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=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
GOOGLE_REDIRECT_URI=https://supermock.ru/api/auth/callback/google
```

#### Google API токены:

```env
GOOGLE_ACCESS_TOKEN=ya29.a0AW4XtxjXlWgVhVULoc9M63K3Y9a2njWnYj8Ho7Y...
GOOGLE_REFRESH_TOKEN=1//044fRtClmMuoKCgYIARAAGAQSNwF-L9Ir3ClAqpUNfkVdCA3USQiM...
GOOGLE_TOKEN_EXPIRY=1747483200000
```

#### Отсутствующие настройки для многоуровневой аутентификации:

- GitHub OAuth credentials
- Дополнительные провайдеры

## 6. Схемы текущих потоков аутентификации

### 6.1 Google OAuth Flow

```
1. Пользователь нажимает "Войти через Google"
2. Перенаправление на Google OAuth
3. Google возвращает authorization code
4. NextAuth обменивает code на токены
5. Создание/обновление записи в таблице Account
6. Создание сессии пользователя
7. Сохранение токенов в БД для дальнейшего использования
```

### 6.2 Credentials Flow (только для суперадмина)

```
1. Ввод username/password на странице входа
2. Поиск пользователя с ролью 'superadmin'
3. Проверка пароля (bcrypt или fallback)
4. Создание JWT сессии с ролью
5. Перенаправление на главную страницу
```

### 6.3 Google Calendar Integration Flow

```
1. Получение userId из сессии
2. Поиск Google токенов в БД по userId
3. Проверка срока действия токенов
4. Автоматическое обновление при необходимости
5. Создание OAuth2 клиента с актуальными токенами
6. Выполнение операций с Google Calendar API
```

## 7. Точки интеграции для новой системы

### 7.1 Добавление GitHub OAuth

**Требуемые изменения:**

- Добавление GitHub провайдера в NextAuth конфигурацию
- Обновление UI компонентов для поддержки GitHub
- Настройка переменных окружения для GitHub OAuth

### 7.2 Расширение Credentials Provider

**Требуемые изменения:**

- Поддержка обычных пользователей (не только суперадмина)
- Регистрация новых пользователей
- Валидация и хеширование паролей

### 7.3 Условная аутентификация для Google Calendar

**Текущее состояние:**

- Уже реализована через проверку наличия Google токенов
- Автоматическое обновление токенов работает
- Fallback механизмы настроены

## 8. Потенциальные проблемы и ограничения

### 8.1 Безопасность

- Hardcoded fallback пароль в credentials провайдере
- Отсутствие rate limiting для попыток входа
- Логирование чувствительной информации в консоль

### 8.2 Масштабируемость

- Токены Google хранятся как в БД, так и в переменных окружения
- Отсутствие централизованного управления провайдерами
- Жестко заданные scopes для Google OAuth

### 8.3 Пользовательский опыт

- Ограниченный выбор методов аутентификации
- Отсутствие возможности связывания аккаунтов
- Нет восстановления пароля для credentials

## 9. Рекомендации для реализации многоуровневой аутентификации

### 9.1 Архитектурные изменения

1. **Создание единого провайдера менеджера**

   - Централизованное управление всеми провайдерами
   - Динамическая конфигурация провайдеров

2. **Расширение модели User**

   - Добавление полей для связывания аккаунтов
   - Поддержка множественных провайдеров на пользователя

3. **Улучшение системы ролей**
   - Более гранулярные роли и разрешения
   - Условные разрешения для Google функций

### 9.2 Безопасность

1. **Удаление hardcoded паролей**
2. **Добавление rate limiting**
3. **Улучшение логирования** (удаление чувствительных данных)
4. **Добавление CSRF защиты**

### 9.3 Пользовательский интерфейс

1. **Создание универсального компонента аутентификации**
2. **Добавление страницы управления аккаунтом**
3. **Реализация связывания/отвязывания провайдеров**

## 10. Заключение

Текущая система аутентификации имеет прочную основу с NextAuth.js и хорошо интегрирована с Google сервисами. Основные компоненты для многоуровневой аутентификации уже присутствуют, но требуют расширения для поддержки дополнительных провайдеров и улучшения пользовательского опыта.

Ключевые преимущества текущей системы:

- Надежная интеграция с Google OAuth и API
- Автоматическое управление токенами
- Гибкая система ролей
- Хорошая структура базы данных

Основные области для улучшения:

- Добавление поддержки GitHub OAuth
- Расширение credentials провайдера
- Улучшение безопасности
- Создание более гибкого UI для аутентификации

Система готова к расширению и может служить основой для реализации полноценной многоуровневой аутентификации.
